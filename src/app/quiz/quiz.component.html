<main class="quiz-container">

  <!-- Timer Component -->
  <app-timer #quizTimer [duration]="120" [categoryId]="currentCategoryId" (timeExpired)="handleTimeExpired()"
    (timeUpdate)="updateRemainingTime($event)">
  </app-timer>

  <!-- Quiz Header -->
  <div class="quiz-header">
    <h1>Quiz {{ selectedCategory }}</h1>
    @if (showResult){
    <p>Domanda {{ currentQuestionIndex + 1 }} di {{ questions.length }}</p>
    }

  </div>

  <!-- Mostra domanda durante il quiz -->
  @if (currentQuestion && !showResult) {
  <div class="quiz-question-container">
    <h2>Domanda {{ currentQuestionIndex + 1 }}</h2>
    <p class="question-text">{{ currentQuestion.question }}</p>

    <div class="options-container">
      @for (option of currentQuestion.options; track $index) {
      <mat-card class="option-card" [class.selected]="currentQuestion.currentAnswer === $index"
        (click)="selectAnswer($index)">
        <mat-card-content>
          {{ option }}
        </mat-card-content>
      </mat-card>
      }
    </div>
  </div>

  <!-- Pulsante Fine Quiz -->
  <div class="quiz-actions">
    <button mat-raised-button color="primary" [disabled]="!allQuestionsAnswered" (click)="finishQuiz()">
      Termina Quiz
    </button>
  </div>
  }

  <!-- Risultati del Quiz -->
  @if (showResult && isQuizCompleted) {
  <div class="quiz-results">
    <h2>{{ getScoreMessage() }}</h2>

    <div class="score-summary">
      <div class="score-item">
        <strong>Risposte Corrette:</strong> {{ correctAnswers }} / {{ questions.length }}
      </div>
      <div class="score-item">
        <strong>Punteggio Finale:</strong> {{ finalScore }} punti
      </div>
      <div class="score-item">
        <strong>Tempo Rimanente:</strong> {{ remainingTime }} secondi
      </div>
      <button mat-button (click)="saveScore()" [disabled]="scoreSaved">Salva Punteggio</button>
    </div>

    <!-- Revisione Risposte -->
    <div class="answers-review">
      <h3>Revisione Risposte</h3>
      @for (question of questions; track question.id; let i = $index) {
      <div class="question-review">
        <h4>Domanda {{ i + 1 }}: {{ question.question }}</h4>

        <div class="review-options">
          @for (option of question.options; track $index; let optionIndex = $index) {
          <div class="review-option" [ngClass]="{
            'correct': optionIndex === question.correctOptionIndex,
            'wrong': optionIndex === question.currentAnswer && !isAnswerCorrect(i)
          }">
            {{ option }}
            @if (optionIndex === question.correctOptionIndex) {
            <span class="correct-label">(Corretta)</span>
            }
            @if (optionIndex === question.currentAnswer && !isAnswerCorrect(i)) {
            <span class="wrong-label">(La tua risposta)</span>
            }
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Azioni Finali -->
    <div class="final-actions">
      <button mat-button (click)="restartQuiz()">
        Rifai Quiz
      </button>

      <button mat-button (click)="viewCategoryLeaderboard()">
        Classifica {{ selectedCategory }}
      </button>

      <button mat-button (click)="goBackToCategories()">
        Torna alle Categorie
      </button>
    </div>
  </div>
  }

  <!-- Paginator Component (solo durante il quiz) -->
  @if (!showResult && questions.length > 0) {
  <app-paginator [total]="questions.length" [current]="currentQuestionIndex" (change)="onPageChange($event)">
  </app-paginator>
  }

</main>